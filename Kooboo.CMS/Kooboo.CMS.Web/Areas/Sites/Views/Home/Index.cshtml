
@{
    ViewBag.Title = "Start".Localize();
    Layout = "~/Views/Shared/Site.cshtml";
}

@section Panel{
 
}

<div class="block" id="showRelation">
    <h1 class="title">Relation </h1>
	<p>Click on rectangles to see the specific relationships.</p>
</div>


<script>
	var site = [
	{ 'num': 0, 'name': 'site1', 'content': 0, 'membership': 4 },
	{ 'num': 1, 'name': 'site2', 'content': 3, 'membership': 4 },
	{ 'num': 2, 'name': 'site3', 'content': 2, 'membership': 1 },
	{ 'num': 3, 'name': 'site4', 'content': 2, 'membership': 3 }
	];
	var content = ['content1', 'content2', 'content3', 'content4', 'content5'];
	var membership = ['membership1', 'membership2', 'membership3', 'membership4', 'membership5']

	var max_length = Math.max(site.length, content.length, membership.length);

	var w = 1000;
	var rect_w = w / 100 * 20;
	var rect_h = 44;
	var rect_margin_h = w / 100 * 2;
	var h = max_length * (rect_h + rect_margin_h) + 100;

	var svg = d3.select('#showRelation').append('svg').attr('width', w).attr('height', h);

	var marker = svg.append('defs').append('marker')
				.attr('id', 'the_marker')
				.attr('markerWidth', 8)
				.attr('markerHeight', 8)
				.attr('refX', 5)
				.attr('refY', 5)
				.append('circle')
				.attr('cx', 5)
				.attr('cy', 5)
				.attr('r', 2)
				.attr('fill', '#666');

	var titles = svg.selectAll('text.titles').data(['Membership', 'Site', 'Database'])
	.enter().append('text')
	.attr('class', 'titles')
	.attr('style', 'font-family: Arial; font-size: 16px; text-anchor: middle')
	.attr('x', function (d, i) { return i * w / 100 * 30 + w / 100 * 20 })
	.attr('y', 70)
	.text(function (d) { return d });

	svg.selectAll('rect').__proto__.OOOKKK = function () {
		alert(123);
	}

	// rects and texts
	var site_rects = svg.selectAll('rect.site').data(site).enter().append('rect');
	var site_texts = svg.selectAll('text.site').data(site).enter().append('text').attr('class', 'site-text');
	var content_rects = svg.selectAll('rect.content').data(content).enter().append('rect');
	var content_texts = svg.selectAll('text.content').data(content).enter().append('text').attr('class', 'content-text');
	var membership_rects = svg.selectAll('rect.membership').data(membership).enter().append('rect');
	var membership_texts = svg.selectAll('text.membership').data(membership).enter().append('text').attr('class', 'membership-text');

	site_rects.attr('x', w / 100 * 40)
				.attr('y', function (d) { return 100 + d.num * (rect_h + rect_margin_h) })
				.attr('width', rect_w)
				.attr('height', rect_h)
				.attr('class', 'site-rect')
				.attr('data-name', function (d) { return d.name })
				.attr('fill', '#3ca8db')
	site_texts.attr('x', w / 100 * 40 + 8)
				.attr('y', function (d) { return 100 + d.num * (rect_h + rect_margin_h) + 26 })
				.attr('style', 'font-family: Arial; font-size: 14px')
				.attr('fill', '#fff')
				.attr('data-name', function (d) { return d.name })
				.text(function (d) { return d.name });

	content_rects.attr('x', w / 100 * 70)
				.attr('y', function (d, i) { return 100 + i * (rect_h + rect_margin_h) })
				.attr('width', rect_w)
				.attr('height', rect_h)
				.attr('class', 'content-rect')
				.attr('data-name', function (d) { return d })
				.attr('fill', '#1076a6')
	content_texts.attr('x', w / 100 * 70 + 8)
				.attr('y', function (d, i) { return 100 + i * (rect_h + rect_margin_h) + 26 })
				.attr('style', 'font-family: Arial; font-size: 14px')
				.attr('fill', '#fff')
				.attr('data-name', function (d) { return d })
				.text(function (d) { return d });

	membership_rects.attr('x', w / 100 * 10)
				.attr('y', function (d, i) { return 100 + i * (rect_h + rect_margin_h) })
				.attr('width', rect_w)
				.attr('height', rect_h)
				.attr('class', 'membership-rect')
				.attr('data-name', function (d) { return d })
				.attr('fill', '#3cbabb')
	membership_texts.attr('x', w / 100 * 10 + 8)
				.attr('y', function (d, i) { return 100 + i * (rect_h + rect_margin_h) + 26 })
				.attr('style', 'font-family: Arial; font-size: 14px')
				.attr('fill', '#fff')
				.attr('data-name', function (d) { return d })
				.text(function (d) { return d });

	// lines
	var site_member_lines = svg.selectAll('line.site_member').data(site).enter().append('line');
	var site_content_lines = svg.selectAll('line.site_content').data(site).enter().append('line');

	site_member_lines.attr('x1', w / 100 * 40)
					.attr('y1', function (d) { return 100 + d.num * (rect_h + rect_margin_h) + rect_h / 2 })
					.attr('x2', w / 100 * 30)
					.attr('y2', function (d) { return 100 + d.membership * (rect_h + rect_margin_h) + rect_h / 2 })
					.attr('class', 'member-line')
					.attr('marker-end', 'url(#the_marker)')
					.attr('marker-start', 'url(#the_marker)')
					.attr('stroke', '#999');
	site_content_lines.attr('x1', w / 100 * 60)
					.attr('y1', function (d) { return 100 + d.num * (rect_h + rect_margin_h) + rect_h / 2 })
					.attr('x2', w / 100 * 70)
					.attr('y2', function (d) { return 100 + d.content * (rect_h + rect_margin_h) + rect_h / 2 })
					.attr('class', 'content-line')
					.attr('marker-end', 'url(#the_marker)')
					.attr('marker-start', 'url(#the_marker)')
					.attr('stroke', '#999');

	
	var site_export_imgs = svg.selectAll('image.export').data(site).enter().append('image');
	var content_export_imgs = svg.selectAll('image.export').data(content).enter().append('image');
	var membership_export_imgs = svg.selectAll('image.export').data(membership).enter().append('image');

	site_export_imgs.attr('x', w / 100 * 60 - 30)
				.attr('y', function (d) { return 100 + d.num * (rect_h + rect_margin_h) + 10 })
				.attr('width', 24)
				.attr('height', 24)
				.attr('class', 'view')
				.attr('data-name', function (d) { return d.name })
				.attr('xlink:href', '/Images/svg-view.png');
	content_export_imgs.attr('x', w / 100 * 90 - 30)
				.attr('y', function (d, i) { return 100 + i * (rect_h + rect_margin_h) + 10 })
				.attr('width', 24)
				.attr('height', 24)
				.attr('class', 'view')
				.attr('data-name', function (d) { return d })
				.attr('xlink:href', '/Images/svg-view.png');
	membership_export_imgs.attr('x', w / 100 * 30 - 30)
				.attr('y', function (d, i) { return 100 + i * (rect_h + rect_margin_h) + 10 })
				.attr('width', 24)
				.attr('height', 24)
				.attr('class', 'view')
				.attr('data-name', function (d) { return d })
				.attr('xlink:href', '/Images/svg-view.png');
	

	// Show relation
	$('.site-rect').on('click', function (e) {
		$('.content-rect').attr('fill', '#1076a6');
		$('.site-rect').attr('fill', '#3ca8db');
		$('.membership-rect').attr('fill', '#3cbabb');
		$(this).attr('fill', '#d24726');
		var site_name = $(this).data('name');
		for (var i = 0; i < site.length; i++) {
			if (site[i]['name'] == site_name) {
				var index = i;
				break;
			} else {
				continue;
			}
		}
		var content_index = site[index]['content'];
		var membership_index = site[index]['membership'];
		$('.content-rect').eq(content_index).attr('fill', '#d24726');
		$('.membership-rect').eq(membership_index).attr('fill', '#d24726');
	});
	$('.content-rect').on('click', function (e) {
		$('.content-rect').attr('fill', '#1076a6');
		$('.site-rect').attr('fill', '#3ca8db');
		$('.membership-rect').attr('fill', '#3cbabb');
		$(this).attr('fill', '#d24726');
		var index = content.indexOf($(this).data('name'));
		for (var i = 0; i < site.length; i++) {
			if (site[i]['content'] == index) {
				$('.site-rect').eq(site[i]['num']).attr('fill', '#d24726');
				var content_index = site[i]['content'];
				var membership_index = site[i]['membership'];
				$('.content-rect').eq(content_index).attr('fill', '#d24726');
				$('.membership-rect').eq(membership_index).attr('fill', '#d24726');
			}
		}
	});
	$('.membership-rect').on('click', function (e) {
		$('.content-rect').attr('fill', '#1076a6');
		$('.site-rect').attr('fill', '#3ca8db');
		$('.membership-rect').attr('fill', '#3cbabb');
		$(this).attr('fill', '#d24726');
		var index = membership.indexOf($(this).data('name'));
		for (var i = 0; i < site.length; i++) {
			if (site[i]['membership'] == index) {
				$('.site-rect').eq(site[i]['num']).attr('fill', '#d24726');
				var content_index = site[i]['content'];
				var membership_index = site[i]['membership'];
				$('.content-rect').eq(content_index).attr('fill', '#d24726');
				$('.membership-rect').eq(membership_index).attr('fill', '#d24726');
			}
		}
	})

	// Icon action
	$('.site-text, .content-text, .membership-text').on('click', function () {
		alert('jump to ' + $(this).data('name'));
	});
	$('image.view').on('click', function () {
		alert('jump to ' + $(this).data('name'));
	});
</script>




